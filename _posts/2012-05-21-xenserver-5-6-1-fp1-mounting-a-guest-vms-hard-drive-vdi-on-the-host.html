---
layout: post
title: 'XenServer 5.6.1 FP1: Mounting a guest VM''s hard drive (VDI) on the host'
date: 2012-05-21 10:58:40.000000000 +09:30
type: post
published: true
status: publish
categories:
- Infrastructure
- IT
tags:
- XenServer
meta:
  _edit_last: '29818343'
  _oembed_250b21a2942c4e6009f257374a5c9782: "{{unknown}}"
author: Tom Saleeba
---
<h1>Back story</h1>
<p>This is a problem that I ran up against because I was running the host machine as a bare host and all the functionality that I needed was in the guest machine. The purpose of this was to insulate myself from changes in hardware and to be able to easily backup the entire server (the guest) so it could be restored from image. This meant that occasionally I'd need to access files on the guest machine's "hard drive" but it wasn't running so methods that require networking were out. The  solution is to mount the guest's hard drive image on the host to access it like any other partition.</p>
<h1>Assumptions</h1>
<ol>
<li>You're running XenServer 5.6.1 Feature Pack 1. It may work with other versions but I haven't tested.</li>
<li>If you need to mount the file systems on the VDI then your host machine needs to be able to read the file system of the guest's VDI</li>
</ol>
<h1>Prerequisites</h1>
<ol>
<li>The guest VM must be turned off</li>
<li>No other machines are accessing the disk image (two machines cannot share the same disk image)</li>
</ol>
<h1>Basic glossary</h1>
<ul>
<li>UUID: Universally unique identifier. It's a long string of characters that XenServer, in this case, will use to uniqely identify a particular object. You can read more at <a title="http://en.wikipedia.org/wiki/UUID" href="http://en.wikipedia.org/wiki/UUID">http://en.wikipedia.org/wiki/UUID</a></li>
<li>Host: the machine that runs XenServer</li>
<li>Guest: virtual machines that run within the XenServer process</li>
<li>Dom0: A virtual machine that represents the XenServer host</li>
<li>VBD: Virtual Block Device, a way to connect a VDI to a virtual machine</li>
<li>VDI: Virtual Disk Image, an image or file that represents a virtual hard disk.</li>
</ul>
<h1>How to do it</h1>
<p>These instructions are for mounting a guest VM's hard drive, stored in the VDI format on the host.</p>
<ol>
<li>Get the UUID of the Dom0 machine (the host) with<br />
<code>xe vm-list</code></li>
<li>Get the UUID of the VDI (the virtual disk hooked up to the VM) with<br />
<code>xe vm-disk-list --multiple</code></li>
<li>Create a new VBD to plug the virtual disk into the host machine (Dom0) with<br />
<code>xe vbd-create device=0 vm-uuid=<span style="color:#008000;"><em>uuid-of-dom0</em></span> vdi-uuid=<span style="color:#008000;"><em>uuid-of-the-vm-disk</em></span> bootable=false mode=RW type=Disk</code></li>
<li>The previous command would've returned a UUID. This is the UUID of the newly created VBD. Now we need to plug the newly created VBD in with<br />
<code>xe vbd-plug uuid=<span style="color:#008000;"><em>uuid-of-new-vbd-returned-from previous-command</em></span></code></li>
</ol>
<p>The trick is that Dom0 represents the host machine but behaves exactly like a virtual machines so we simply need to create a new VDB that allows a disk image (VDI) to be connected to that machine. The same method works when connecting a VDI to any other guest.</p>
<h1>What now?</h1>
<p>You should be able to see the disk just like you would with any other physical disk attached to the host, so running something like:<br />
<code>df -h</code><br />
should list all the disks attached to the machine and you can then use something like this to mount the disk to a mount point (note you might need to be superuser for this):<br />
<code>mount /dev/sdb1 /mnt/point</code></p>
