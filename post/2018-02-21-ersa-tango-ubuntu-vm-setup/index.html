<!DOCTYPE html>

<html lang="en-us">
    <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="format-detection" content="telephone=no"/>

    <title>TechoTom</title>
    
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="manifest" href="/manifest.json">
    <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#FF3DB4">
    <meta name="theme-color" content="#ffffff">

    
    
    
    <link rel="stylesheet" href="http://blog.techotom.com/css/main.min.03322cbe6bddfc28e7b17b84bc5446282a510b14b57be3371ba1f68ef1ab9ce8.css"/>

    
    
    

    
    
 
    
    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-101335262-2', 'auto');
	
	ga('send', 'pageview');
}
</script>

</head>
    <body>
        
<nav>
  <header>
    <div class="site-title">
        <a href="/">TechoTom</a>
    </div>  
</header>
  <div class="nav-menu">
  
  <a class="color-link nav-link" href="http://blog.techotom.com/index.xml" target="_blank" rel="noopener" type="application/rss+xml">RSS</a>
</div>
<footer class="footer">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

</div>




	<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
	<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>

	<script src="http://blog.techotom.com/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
</nav>
        <div id="content" class="content-container">
        
<h1 class="post-title">eRSA Tango Ubuntu VM setup</h1>
    
    <time>February 21, 2018</time>
    
    <div>
        <p>
        <h1 id="some-background">Some background</h1>
<p>I&rsquo;ve just started playing with <a href="https://www.ersa.edu.au/service/cloud/tango-cloud/">eRSA&rsquo;s Tango cloud</a> and found that a fresh Ubuntu VM isn&rsquo;t the same as what I&rsquo;m used to when launching something on OpenStack or AWS. I&rsquo;ll run through each issue I found and how I fixed it.</p>
<h1 id="connecting-to-the-vm">Connecting to the VM</h1>
<p>This is a good first step. In the OpenStack or AWS EC2 worlds, you&rsquo;ll be used to setting up a keypair and using a <code>.pem</code> file to authenticate when connecting via SSH. Tango is different, it uses your username and password for your eRSA account. These are the details that you used to login to the Tango dashboard. You&rsquo;ll connect with something like</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh &lt;username&gt;@&lt;ip address&gt;
<span style="color:#75715e"># assuming username = bob and IP address = 11.22.33.44</span>
ssh bob@11.22.33.44
</code></pre></div><h1 id="changing-from-password-auth-to-pem-auth">Changing from password auth to <code>.pem</code> auth</h1>
<p>You need a public/private key pair for this step. If you don&rsquo;t have one, you can read how to get one over at <a href="https://www.digitalocean.com/community/tutorials/how-to-set-up-ssh-keys--2">DigitalOcean</a>. If you follow their guide, we&rsquo;re talking about the <code>id_rsa.pub</code> file in their guide.</p>
<p>First, copy the contents of your public key file to your clipboard, then we&rsquo;ll connect via SSH and add it to the VM&rsquo;s trusted keys</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">ssh &lt;username&gt;@&lt;ip address&gt; <span style="color:#75715e"># SSH to the VM, using your password</span>
touch ~/.ssh/authorized_keys <span style="color:#75715e"># create the file if it doesn&#39;t exist</span>
nano ~/.ssh/authorized_keys <span style="color:#75715e"># edit the file</span>
</code></pre></div><p>Now paste the contents of your public key (<code>id_rsa.pub</code>) onto a new line in this <code>authorized_keys</code> file. The line will start with something like: <code>ssh-rsa AAAAC...</code>. Save and exit the editor, <code>Ctrl+x</code> will do this, answer <code>y</code> to save the file and exit.</p>
<p>Now we&rsquo;ll disable password authentication to force use of the public/private keys.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo nano /etc/ssh/sshd_config <span style="color:#75715e"># open editor</span>
</code></pre></div><p>Change <code>PasswordAuthentication</code> from <code>yes</code> to <code>no</code> and uncomment the line (remove the leading <code>#</code>).</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">PasswordAuthentication no
</code></pre></div><p>Open a new terminal for the next bit, it can&rsquo;t hurt to leave the existing SSH session connected in case you&rsquo;ve locked yourself out of new connections.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># SSH to the VM, using your private key</span>
ssh -i ~/.ssh/id_rsa &lt;username&gt;@&lt;ip address&gt;
</code></pre></div><p>If it connected, you&rsquo;ve successfully set it up.</p>
<h1 id="no-password-for-sudo">No password for <code>sudo</code></h1>
<p>Even after we&rsquo;ve set up <code>.pem</code> auth for SSH, you&rsquo;ll still be prompted for your password every time you need to sudo (or every 10 minutes at least). You can stop this with the following</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash"><span style="color:#75715e"># ssh to the VM</span>
sudo visudo <span style="color:#75715e"># this is the last time you&#39;ll need to use your password ;)</span>
</code></pre></div><p>Then add a line to this file with the following format</p>
<pre><code>&lt;username&gt; ALL=(ALL) NOPASSWD: ALL
</code></pre><p>Just replace <code>&lt;username&gt;</code> with your username. You can get that by running <code>id -un</code>. Save and exit the editor (<code>Ctrl+x</code>). Now run a test command to make sure you don&rsquo;t get prompted for a password</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">sudo ls
</code></pre></div><h1 id="change-your-default-shell">Change your default shell</h1>
<p>The default shell for me was <code>/dev/tcsh</code>. That might be your thing but assume you want to change it to good old bash. Normally you could use <code>chsh</code> to change your shell but that will (likely) fail</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">$ chsh
Password: 
Changing the login shell <span style="color:#66d9ef">for</span> user1
Enter the new value, or press ENTER <span style="color:#66d9ef">for</span> the default
	Login Shell <span style="color:#f92672">[</span>/bin/tcsh<span style="color:#f92672">]</span>: /bin/bash
chsh: user <span style="color:#e6db74">&#39;user1&#39;</span> does not exist in /etc/passwd
</code></pre></div><p>The error message makes a valid point, we aren&rsquo;t in <code>/etc/passwd</code> because ActiveDirectory powers our auth.</p>
<p>A very useful <a href="https://serverfault.com/a/742130/265053">answer</a> at serverfault.com gives the solution to this.</p>
<blockquote>
<pre><code>getent passwd USERNAME
</code></pre>
<p>This will have the valid entry equivalent for your user in /etc/passwd, take this, paste it in to /etc/passwd and update the shell at the end for the valid path of the shell you want to use. This way it doesn&rsquo;t change it for all users, and you can make sure that shell is on the machine you&rsquo;re configuring this on before making the change.</p>
</blockquote>
<p>We can chain that command into tee so we can append it to <code>/etc/passwd</code> with the following</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">getent passwd <span style="color:#e6db74">`</span>id -un<span style="color:#e6db74">`</span> | sudo tee -a /etc/passwd
</code></pre></div><p>Now we can run our command to change shell</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">chsh
</code></pre></div><p>&hellip;or you could just edit the <code>/etc/passwd</code> file directly to change your shell.</p>
<p>You&rsquo;ll need to exit your SSH session and connect again to see your new default shell.</p>

        </p>
    </div>
    <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "techotom" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

    <div class="page-footer">
        
        <hr class="footer-divider">
        
            <a class="tag" href="/tags/cloud">#cloud</a>
        
      
    </div>


        
        </div>
        <footer class="footer-mobile">
	<div class="social-icons">
        

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    

    
    
    

    
    
    

    

    

    

    

</div>




	<div class="footer-mobile-links">
		<p><a href="https://github.com/kimcc/hugo-theme-noteworthy" target="_blank" rel="noopener">Noteworthy theme</a></p>
		<span class="divider-bar">|</span>
		<p><a href="https://gohugo.io" target="_blank" rel="noopener">Built with Hugo</a></p>
	</div>

	<script src="http://blog.techotom.com/js/main.min.fa5c2b23e07b5d9bfad267a52b4b24fdb053e6fb7524993383594926a3ac270c.js" integrity="sha256-+lwrI+B7XZv60melK0sk/bBT5vt1JJkzg1lJJqOsJww="></script>
</footer>
    </body>
</html>